name: CI and Native Build

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to NPM'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version tag (if publishing)'
        required: false
        type: string

jobs:
  # First job: Setup and verify the repository
  setup:
    name: Setup Repository
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: false  # We'll handle submodules manually
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Check llama.cpp submodule
        id: check-submodule
        run: |
          # Check if llama.cpp directory already exists and is at the right version
          if [ -d "cpp/llama.cpp" ] && [ -f "cpp/llama.cpp/include/llama.h" ]; then
            echo "Submodule exists, checking status..."
            cd cpp/llama.cpp
            git fetch
            LOCAL_COMMIT=$(git rev-parse HEAD)
            SOURCE_REPO_LLAMA="https://github.com/ggerganov/llama.cpp.git"
            SOURCE_BRANCH_LLAMA="master"
            REMOTE_COMMIT=$(git ls-remote $SOURCE_REPO_LLAMA $SOURCE_BRANCH_LLAMA | awk '{print $1}')
            
            if [ "$LOCAL_COMMIT" = "$REMOTE_COMMIT" ]; then
              echo "Submodule is up to date"
              echo "is_updated=true" >> $GITHUB_OUTPUT
            else
              echo "Submodule needs update"
              echo "is_updated=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Submodule not initialized"
            echo "is_updated=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Initialize or update submodules
        if: steps.check-submodule.outputs.is_updated != 'true'
        run: scripts/setupLlamaCpp.sh init
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Validate package.json
        run: |
          echo "Validating package.json configuration..."
          
          # Extract and validate the 'files' field
          FILES=$(node -p "JSON.stringify(require('./package.json').files || [])")
          echo "Files included in package: $FILES"
          
          # Check for required files/directories
          for REQUIRED in "android" "ios" "lib" "cpp" "src" "LICENSE" "README.md" "RNLlamaCpp.podspec"; do
            if ! echo "$FILES" | grep -q "$REQUIRED"; then
              echo "‚ö†Ô∏è Warning: '$REQUIRED' might be missing from package.json 'files' field"
            fi
          done
          
          # Check that scripts directory is not included
          if echo "$FILES" | grep -q "scripts"; then
            echo "‚ö†Ô∏è Warning: 'scripts' directory is included in package.json 'files' field but should be excluded from the published package"
          fi
      
      - name: Get version from package.json or tag
        id: get-version
        run: |
          # If this is triggered by a tag, use the tag as version
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          # If version is provided via workflow input, use that
          elif [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          # Otherwise use package.json version
          else
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"
      
      - name: Upload Repository State
        uses: actions/upload-artifact@v4
        with:
          name: repo-state
          path: .
          retention-days: 1
  
  # Android build job
  android-build:
    name: Android Native Build
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Restore file permissions
        run: |
          chmod +x scripts/*.sh
          find android -name "*.sh" -exec chmod +x {} \; || true
          find android -name "gradlew" -exec chmod +x {} \; || true
      
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: 'platforms;android-35 build-tools;35.0.0 ndk;28.2.13676358 cmake;3.22.1'
          accept-android-sdk-licenses: true
      
      # Cache NDK and prebuilt GPU libraries
      - name: Cache NDK and GPU Libraries
        uses: actions/cache@v4
        id: cache-android-libs
        with:
          path: |
            ${{ env.ANDROID_HOME }}/ndk/28.2.13676358
            prebuilt/gpu
            prebuilt/libs/external/opencl
            prebuilt/third_party
          key: android-ndk-gpu-${{ runner.os }}-v1
          restore-keys: |
            android-ndk-gpu-
      
      - name: Prepare GPU Backend Headers
        run: |
          # Get Android NDK path
          NDK_PATH=$ANDROID_HOME/ndk/28.2.13676358
          
          # Create required directories to avoid cache errors
          mkdir -p prebuilt/gpu
          mkdir -p prebuilt/libs/external/opencl
          mkdir -p prebuilt/third_party/Vulkan-Headers
          
          # Skip header preparation if we have a cache hit
          if [ "${{ steps.cache-android-libs.outputs.cache-hit }}" == "true" ] && \
             [ -d "prebuilt/libs/external/opencl/CL" ] && \
             [ -d "prebuilt/third_party/Vulkan-Headers/include/vulkan" ]; then
            echo "‚úÖ Using cached GPU headers"
          else
            # Prepare GPU backend headers (OpenCL and Vulkan)
            # NOTE: This only prepares headers for build-time. We do NOT build system loaders.
            echo "Preparing Android GPU backend headers..."
            chmod +x scripts/build_android_gpu_backend.sh
            export GGML_VK_DISABLE_COOPMAT=1
            export GGML_VK_DISABLE_COOPMAT2=1
            scripts/build_android_gpu_backend.sh --abi=all --clean
          fi
          
          # Verify headers were prepared
          if [ -d "prebuilt/libs/external/opencl/CL" ]; then
            echo "‚úÖ OpenCL headers prepared"
            ls -la prebuilt/libs/external/opencl/CL/ | head -5
          else
            echo "‚ö†Ô∏è OpenCL headers not found (may be disabled)"
          fi
          
          if [ -d "prebuilt/third_party/Vulkan-Headers/include/vulkan" ]; then
            echo "‚úÖ Vulkan headers prepared"
            ls -la prebuilt/third_party/Vulkan-Headers/include/vulkan/ | head -5
          else
            echo "‚ö†Ô∏è Vulkan headers not found (may be disabled)"
          fi
          
          # Check for Vulkan environment files
          if [ -f "prebuilt/gpu/arm64-v8a/.vulkan_env" ]; then
            echo "‚úÖ Vulkan environment file created"
            cat prebuilt/gpu/arm64-v8a/.vulkan_env
          else
            echo "‚ö†Ô∏è No Vulkan environment file found"
          fi

      - name: Build GGML GPU Backend Libraries
        run: |
          # Get Android NDK path
          NDK_PATH=$ANDROID_HOME/ndk/28.2.13676358
          
          # Build GGML GPU backend libraries (libggml-opencl.so and libggml-vulkan.so)
          # These are separate from the main llama.cpp libraries and will be loaded dynamically
          echo "Building GGML GPU backend libraries..."
          chmod +x scripts/build_android_ggml_gpu_backends.sh
          export GGML_VK_DISABLE_COOPMAT=1
          export GGML_VK_DISABLE_COOPMAT2=1
          scripts/build_android_ggml_gpu_backends.sh --abi=all --clean
          
          # Verify GGML GPU backend libraries were built
          echo "Verifying GGML GPU backend libraries..."
          for ABI in arm64-v8a x86_64; do
            if [ -f "prebuilt/gpu/$ABI/libggml-opencl.so" ]; then
              echo "‚úÖ libggml-opencl.so built for $ABI"
              ls -lh prebuilt/gpu/$ABI/libggml-opencl.so
            else
              echo "‚ö†Ô∏è libggml-opencl.so not found for $ABI (may be disabled)"
            fi
            if [ -f "prebuilt/gpu/$ABI/libggml-vulkan.so" ]; then
              echo "‚úÖ libggml-vulkan.so built for $ABI"
              ls -lh prebuilt/gpu/$ABI/libggml-vulkan.so
            else
              echo "‚ö†Ô∏è libggml-vulkan.so not found for $ABI (may be disabled)"
            fi
          done

      - name: Setup Hexagon SDK (for Snapdragon devices)
        id: setup-hexagon
        continue-on-error: true
        run: |
          # Download Hexagon SDK from GitHub releases (same approach as llama.cpp CI)
          HEXSDK_VER=6.4.0.2
          HEXTLS_VER=19.0.04
          
          echo "Downloading Hexagon SDK v${HEXSDK_VER}..."
          curl -L -o hex-sdk.tar.xz https://github.com/snapdragon-toolchain/hexagon-sdk/releases/download/v${HEXSDK_VER}/hexagon-sdk-v${HEXSDK_VER}-amd64-lnx.tar.xz || {
            echo "‚ö†Ô∏è  Hexagon SDK download failed - Hexagon backend will not be built"
            echo "hexagon_available=false" >> $GITHUB_OUTPUT
            exit 0
          }
          
          mkdir -p hex-sdk
          tar -xaf hex-sdk.tar.xz -C hex-sdk || {
            echo "‚ö†Ô∏è  Hexagon SDK extraction failed"
            echo "hexagon_available=false" >> $GITHUB_OUTPUT
            exit 0
          }
          
          # Move to /opt/hexagon (requires sudo in CI)
          sudo mkdir -p /opt/hexagon
          sudo mv hex-sdk/* /opt/hexagon/${HEXSDK_VER} || {
            echo "‚ö†Ô∏è  Failed to install Hexagon SDK to /opt"
            echo "hexagon_available=false" >> $GITHUB_OUTPUT
            exit 0
          }
          
          # Set environment variables
          echo "HEXAGON_SDK_ROOT=/opt/hexagon/${HEXSDK_VER}" >> $GITHUB_ENV
          echo "HEXAGON_TOOLS_ROOT=/opt/hexagon/${HEXSDK_VER}/tools/HEXAGON_Tools/${HEXTLS_VER}" >> $GITHUB_ENV
          echo "DEFAULT_HLOS_ARCH=64" >> $GITHUB_ENV
          echo "DEFAULT_TOOLS_VARIANT=toolv19" >> $GITHUB_ENV
          echo "DEFAULT_NO_QURT_INC=0" >> $GITHUB_ENV
          echo "DEFAULT_DSP_ARCH=v73" >> $GITHUB_ENV
          
          echo "‚úÖ Hexagon SDK installed successfully"
          echo "hexagon_available=true" >> $GITHUB_OUTPUT
          ls -la /opt/hexagon/${HEXSDK_VER} | head -10

      - name: Build Final Android Libraries
        run: |
          # Get Android NDK path
          NDK_PATH=$ANDROID_HOME/ndk/28.2.13676358
          
          # Get glslc path
          GLSLC_PATH="$ANDROID_HOME/ndk/28.2.13676358/shader-tools/linux-x86_64/glslc"
          
          # Build the final Android libraries (main llama.cpp libraries)
          # The GGML GPU backend libraries (libggml-opencl.so, libggml-vulkan.so) 
          # are already built in the previous step and will be copied to jniLibs
          echo "Building Android main libraries..."
          chmod +x scripts/build_android_external.sh
          export GGML_VK_DISABLE_COOPMAT=1
          export GGML_VK_DISABLE_COOPMAT2=1
          
          # Build with Hexagon if SDK is available
          if [ "${{ steps.setup-hexagon.outputs.hexagon_available }}" = "true" ]; then
            echo "Building with Hexagon support for arm64-v8a..."
            scripts/build_android_external.sh --abi=arm64-v8a --hexagon
            # Build other ABIs without Hexagon
            for ABI in x86_64 armeabi-v7a x86; do
              echo "Building for $ABI (without Hexagon)..."
              scripts/build_android_external.sh --abi=$ABI || true
            done
          else
            echo "Building without Hexagon support..."
            scripts/build_android_external.sh --abi=all
          fi
          
          # Copy GGML GPU backend libraries from prebuilt/gpu to jniLibs
          echo "Copying GGML GPU backend libraries to jniLibs..."
          for ABI in arm64-v8a x86_64 armeabi-v7a x86; do
            if [ -d "prebuilt/gpu/$ABI" ]; then
              mkdir -p android/src/main/jniLibs/$ABI
              for backend_lib in libggml-opencl.so libggml-vulkan.so; do
                if [ -f "prebuilt/gpu/$ABI/$backend_lib" ]; then
                  cp "prebuilt/gpu/$ABI/$backend_lib" "android/src/main/jniLibs/$ABI/"
                  echo "‚úÖ Copied $backend_lib to jniLibs/$ABI/"
                fi
              done
            fi
          done
          
          # Copy Hexagon backend libraries if built (Snapdragon devices - arm64-v8a only)
          # Hexagon libraries are built by build_android_external.sh and placed in jniLibs
          # but we also check the build directory as fallback
          if [ -f "android/src/main/jniLibs/arm64-v8a/libggml-hexagon.so" ]; then
            echo "‚úÖ Hexagon backend library already in jniLibs/arm64-v8a/"
          else
            # Check if Hexagon was built in the external build directory
            HEXAGON_BUILD_DIR="prebuilt/libs/external/android/arm64-v8a"
            if [ -f "$HEXAGON_BUILD_DIR/libggml-hexagon.so" ]; then
              mkdir -p android/src/main/jniLibs/arm64-v8a
              cp "$HEXAGON_BUILD_DIR/libggml-hexagon.so" "android/src/main/jniLibs/arm64-v8a/"
              echo "‚úÖ Copied libggml-hexagon.so to jniLibs/arm64-v8a/"
              
              # Also copy HTP libraries if they exist
              for htp_lib in libggml-htp-v68.so libggml-htp-v69.so libggml-htp-v73.so libggml-htp-v75.so libggml-htp-v79.so libggml-htp-v81.so; do
                if [ -f "$HEXAGON_BUILD_DIR/$htp_lib" ]; then
                  cp "$HEXAGON_BUILD_DIR/$htp_lib" "android/src/main/jniLibs/arm64-v8a/"
                  echo "‚úÖ Copied $htp_lib to jniLibs/arm64-v8a/"
                fi
              done
            elif [ "${{ steps.setup-hexagon.outputs.hexagon_available }}" = "true" ]; then
              echo "‚ö†Ô∏è  Hexagon SDK was available but libraries not found - build may have failed"
            else
              echo "‚ÑπÔ∏è  Hexagon backend not built (SDK not available in CI)"
            fi
          fi
          
          # Verify final jniLibs contents
          echo "Verifying final jniLibs contents..."
          VERIFICATION_FAILED=0
          for ABI in arm64-v8a x86_64 armeabi-v7a x86; do
            echo "üì¶ Libraries in jniLibs/$ABI/:"
            ls -lh android/src/main/jniLibs/$ABI/ || echo "  (directory not found)"
            
            # Verify we have the main libraries (REQUIRED for all ABIs)
            if [ ! -f "android/src/main/jniLibs/$ABI/libllama.so" ]; then
              echo "‚ùå ERROR: libllama.so missing for $ABI"
              VERIFICATION_FAILED=1
            else
              echo "‚úÖ libllama.so present"
            fi
            if [ ! -f "android/src/main/jniLibs/$ABI/libggml.so" ]; then
              echo "‚ùå ERROR: libggml.so missing for $ABI"
              VERIFICATION_FAILED=1
            else
              echo "‚úÖ libggml.so present"
            fi
            if [ ! -f "android/src/main/jniLibs/$ABI/libggml-base.so" ]; then
              echo "‚ùå ERROR: libggml-base.so missing for $ABI"
              VERIFICATION_FAILED=1
            else
              echo "‚úÖ libggml-base.so present"
            fi
            
            # Verify CPU backend libraries
            if [ "$ABI" = "arm64-v8a" ]; then
              # For arm64-v8a, we should have CPU variants (GGML_CPU_ALL_VARIANTS enabled)
              CPU_VARIANT_COUNT=$(ls -1 android/src/main/jniLibs/$ABI/libggml-cpu-android_armv8*.so 2>/dev/null | wc -l)
              if [ "$CPU_VARIANT_COUNT" -gt 0 ]; then
                echo "‚úÖ Found $CPU_VARIANT_COUNT CPU variant libraries for $ABI:"
                ls -1 android/src/main/jniLibs/$ABI/libggml-cpu-android_armv8*.so | sed 's/.*\//  - /'
              else
                # Fallback: check for single libggml-cpu.so
                if [ -f "android/src/main/jniLibs/$ABI/libggml-cpu.so" ]; then
                  echo "‚ö†Ô∏è  Only single libggml-cpu.so found (CPU variants not built - may indicate build issue)"
                else
                  echo "‚ùå ERROR: No CPU backend libraries found for $ABI"
                  VERIFICATION_FAILED=1
                fi
              fi
            else
              # For other ABIs, single libggml-cpu.so is expected
              if [ -f "android/src/main/jniLibs/$ABI/libggml-cpu.so" ]; then
                echo "‚úÖ libggml-cpu.so present"
              else
                echo "‚ùå ERROR: libggml-cpu.so missing for $ABI"
                VERIFICATION_FAILED=1
              fi
            fi
            
            # Verify GGML GPU backends (only for 64-bit ABIs)
            if [ "$ABI" = "arm64-v8a" ] || [ "$ABI" = "x86_64" ]; then
              if [ -f "android/src/main/jniLibs/$ABI/libggml-opencl.so" ]; then
                echo "‚úÖ libggml-opencl.so present"
              else
                echo "‚ö†Ô∏è  libggml-opencl.so not found (optional - GPU backend)"
              fi
              if [ -f "android/src/main/jniLibs/$ABI/libggml-vulkan.so" ]; then
                echo "‚úÖ libggml-vulkan.so present"
              else
                echo "‚ö†Ô∏è  libggml-vulkan.so not found (optional - GPU backend)"
              fi
            fi
            
            # Verify Hexagon backend (arm64-v8a only)
            if [ "$ABI" = "arm64-v8a" ]; then
              if [ -f "android/src/main/jniLibs/$ABI/libggml-hexagon.so" ]; then
                echo "‚úÖ libggml-hexagon.so present"
                # Check for HTP libraries
                HTP_COUNT=$(ls -1 android/src/main/jniLibs/$ABI/libggml-htp-*.so 2>/dev/null | wc -l)
                if [ "$HTP_COUNT" -gt 0 ]; then
                  echo "‚úÖ $HTP_COUNT Hexagon HTP libraries present"
                else
                  echo "‚ö†Ô∏è  Hexagon HTP libraries not found (Hexagon backend may not work)"
                fi
              else
                echo "‚ÑπÔ∏è  libggml-hexagon.so not present (optional - requires HEXAGON_SDK_ROOT to build)"
              fi
            fi
            
            # Verify we're NOT shipping system libraries (should not be in our package)
            if [ -f "android/src/main/jniLibs/$ABI/libOpenCL.so" ]; then
              echo "‚ùå ERROR: libOpenCL.so found - should NOT be shipped!"
              echo "  libOpenCL.so is a system library, not our build output"
              exit 1
            fi
            if [ -f "android/src/main/jniLibs/$ABI/libvulkan.so" ]; then
              echo "‚ùå ERROR: libvulkan.so found - should NOT be shipped!"
              echo "  libvulkan.so is a system library, not our build output"
              exit 1
            fi
            
            echo ""
          done
          
          # Fail if any required libraries are missing
          if [ "$VERIFICATION_FAILED" -eq 1 ]; then
            echo "‚ùå Verification failed - some required libraries are missing!"
            exit 1
          else
            echo "‚úÖ All required libraries verified successfully!"
          fi
      
      - name: Upload Android Native Libs
        uses: actions/upload-artifact@v4
        with:
          name: android-native-libs
          path: android/src/main/jniLibs/
  
  # iOS build job
  ios-build:
    name: iOS Native Build
    needs: setup
    runs-on: macos-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Restore file permissions
        run: |
          chmod +x scripts/*.sh
      
      # Cache iOS framework to speed up builds
      - name: Cache iOS Framework
        uses: actions/cache@v4
        id: cache-ios-framework
        with:
          path: |
            ios/libs/llama.xcframework
          key: ios-framework-${{ runner.os }}-v1
          restore-keys: |
            ios-framework-
      
      - name: Setup iOS Framework
        run: |
          # Skip framework download if we have a cache hit
          if [ "${{ steps.cache-ios-framework.outputs.cache-hit }}" == "true" ] && [ -d "ios/libs/llama.xcframework" ]; then
            echo "‚úÖ Using cached iOS framework"
          else
            # Use the build_apple_external.sh to set up iOS framework
            scripts/build_apple_external.sh init
          fi
          
          # Verify the iOS xcframework was set up correctly
          if [ ! -d "ios/libs/llama.xcframework" ]; then
            echo "‚ùå iOS framework build failed!"
            exit 1
          else
            echo "‚úÖ iOS framework downloaded successfully"
            
            # List available slices
            echo "Available iOS framework slices:"
            ls -la ios/libs/llama.xcframework/
          fi
          
      - name: Upload iOS Framework
        uses: actions/upload-artifact@v4
        with:
          name: ios-framework
          path: ios/libs/llama.xcframework/
          
      - name: Validate iOS Podspec
        run: |
          # Check if the podspec exists
          if [ ! -f "RNLlamaCpp.podspec" ]; then
            echo "‚ùå RNLlamaCpp.podspec not found"
            exit 1
          fi
          
          # Just check the podspec content without running validation
          if grep -q "s.vendored_frameworks" RNLlamaCpp.podspec && 
             grep -q "install_modules_dependencies" RNLlamaCpp.podspec; then
            echo "‚úÖ Podspec contains required sections including Turbo Module dependencies"
          else
            echo "‚ùå Podspec is missing required sections"
            exit 1
          fi
          
          echo "‚úÖ iOS library setup validated"
  
  # Test Android-specific code
  test-android:
    name: Test Android Code
    needs: [setup, android-build]
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
          
      - name: Download Android Libraries
        uses: actions/download-artifact@v4
        with:
          name: android-native-libs
          path: android/src/main/jniLibs/
      
      - name: Restore file permissions
        run: |
          chmod +x scripts/*.sh
          find android -name "*.sh" -exec chmod +x {} \; || true
          find android -name "gradlew" -exec chmod +x {} \; || true
      
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Android-specific tests
        run: npm run test-android || echo "No Android-specific tests defined, skipping"
  
  # Test iOS-specific code
  test-ios:
    name: Test iOS Code
    needs: [setup, ios-build]
    runs-on: macos-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
          
      - name: Download iOS Framework
        uses: actions/download-artifact@v4
        with:
          name: ios-framework
          path: ios/libs/llama.xcframework/
      
      - name: Restore file permissions
        run: |
          chmod +x scripts/*.sh
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run iOS-specific tests
        run: npm run test-ios || echo "No iOS-specific tests defined, skipping"
  
  # Run general JS/TS tests
  test-js:
    name: Test JavaScript/TypeScript
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run JS/TS tests
        run: npm test
  
  # Job to report successful build and tests
  build-success:
    name: CI and Native Build Success
    needs: [setup, android-build, ios-build, test-android, test-ios, test-js]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Check Status
        run: |
          if [ "${{ needs.setup.result }}" = "success" ] && 
             [ "${{ needs.android-build.result }}" = "success" ] && 
             [ "${{ needs.ios-build.result }}" = "success" ] && 
             [ "${{ needs.test-android.result }}" = "success" ] && 
             [ "${{ needs.test-ios.result }}" = "success" ] && 
             [ "${{ needs.test-js.result }}" = "success" ]; then
            echo "All CI and Native Build steps passed!"
            exit 0
          else
            echo "One or more steps failed!"
            echo "Setup: ${{ needs.setup.result }}"
            echo "Android Build: ${{ needs.android-build.result }}"
            echo "iOS Build: ${{ needs.ios-build.result }}"
            echo "Android Tests: ${{ needs.test-android.result }}"
            echo "iOS Tests: ${{ needs.test-ios.result }}"
            echo "JS Tests: ${{ needs.test-js.result }}"
            exit 1
          fi
  
  # Publish job - only runs on main branch when a semver tag (vX.Y.Z) is pushed or when a release is published
  publish:
    name: Publish to NPM
    if: (github.event_name == 'release') || (github.ref == 'refs/heads/main' && github.event.inputs.publish == 'true') || (startsWith(github.ref, 'refs/tags/v') && (contains(github.ref, '.') || contains(github.ref, '-')))
    needs: [build-success]
    runs-on: ubuntu-latest
    steps:
      - name: Download Repository
        uses: actions/download-artifact@v4
        with:
          name: repo-state
          path: .
          
      - name: Download Android Libraries
        uses: actions/download-artifact@v4
        with:
          name: android-native-libs
          path: android/src/main/jniLibs/
          
      - name: Download iOS Framework
        uses: actions/download-artifact@v4
        with:
          name: ios-framework
          path: ios/libs/llama.xcframework/
      
      - name: Restore file permissions
        run: |
          chmod +x scripts/*.sh
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        run: |
          # Install dependencies including react-native-builder-bob
          npm ci
          
          # Verify bob is installed
          npx bob --version || echo "‚ùå bob not found after installation"
      
      - name: Extract version from tag, release, or input
        id: get-version
        run: |
          # If triggered by a release, use the release tag
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            # Remove 'v' prefix if present
            VERSION="${VERSION#v}"
            echo "Version from release: $VERSION"
          # Use input version if provided through workflow dispatch
          elif [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Version from input: $VERSION"
          # Extract version from git tag (remove the 'v' prefix)
          elif [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "Version from tag: $VERSION"
          # Fallback to package.json version
          else
            VERSION=$(node -p "require('./package.json').version")
            echo "Version from package.json: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Validate semver format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "‚ö†Ô∏è Warning: Version '$VERSION' does not follow semver format x.y.z(-suffix)"
          else
            echo "‚úÖ Version '$VERSION' follows semver format"
          fi
      
      - name: Update version in package.json
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          echo "Target version: $VERSION"
          echo "Current version: $CURRENT_VERSION"
          
          if [ "$VERSION" = "$CURRENT_VERSION" ]; then
            echo "‚úÖ Version is already correct ($VERSION), no update needed"
          else
            echo "Updating version from $CURRENT_VERSION to $VERSION"
            npm version "$VERSION" --no-git-tag-version
            echo "‚úÖ Version updated successfully"
          fi
          
          # Show the final package.json version
          echo "Final version in package.json:"
          cat package.json | grep -A 3 "\"name\":"
      
      - name: Build package
        run: |
          # Run prepare script which uses bob
          npm run prepare
          
          # Verify the build output
          if [ ! -d "lib" ] || [ ! "$(ls -A lib 2>/dev/null)" ]; then
            echo "‚ùå Build failed - lib directory is empty or missing"
            exit 1
          fi
          echo "‚úÖ Build completed successfully"
          ls -la lib
      
      - name: Verify package content
        run: |
          echo "Checking files to be included in the package..."
          # Extract 'files' field from package.json
          FILES=$(node -p "JSON.stringify(require('./package.json').files || [])")
          echo "Files specified in package.json: $FILES"
          
          # Verify core directories and files are included
          for REQUIRED in "android" "ios" "lib" "cpp" "src" "LICENSE" "README.md" "RNLlamaCpp.podspec"; do
            if ! echo "$FILES" | grep -q "$REQUIRED"; then
              echo "‚ö†Ô∏è Warning: '$REQUIRED' might be missing from package.json 'files' field"
            fi
          done
          
          # Verify that scripts directory is not included
          if echo "$FILES" | grep -q "scripts"; then
            echo "‚ö†Ô∏è Warning: 'scripts' directory is included in package.json 'files' field but should be excluded from the published package"
          fi
          
          # Verify native libraries exist and are complete
          if [ ! -d "android/src/main/jniLibs" ] || [ ! "$(ls -A android/src/main/jniLibs 2>/dev/null)" ]; then
            echo "‚ùå Android native libraries missing!"
            exit 1
          else
            echo "‚úÖ Android native libraries present"
            ls -la android/src/main/jniLibs
            
            # Verify required libraries for each ABI
            for ABI in arm64-v8a x86_64 armeabi-v7a x86; do
              if [ ! -d "android/src/main/jniLibs/$ABI" ]; then
                echo "‚ùå ERROR: Missing ABI directory: $ABI"
                exit 1
              fi
              
              # Check required libraries
              REQUIRED_LIBS=("libllama.so" "libggml.so" "libggml-base.so")
              for lib in "${REQUIRED_LIBS[@]}"; do
                if [ ! -f "android/src/main/jniLibs/$ABI/$lib" ]; then
                  echo "‚ùå ERROR: Missing required library $lib for $ABI"
                  exit 1
                fi
              done
              
              # For arm64-v8a, verify CPU variants are present
              if [ "$ABI" = "arm64-v8a" ]; then
                CPU_VARIANT_COUNT=$(ls -1 android/src/main/jniLibs/$ABI/libggml-cpu-android_armv8*.so 2>/dev/null | wc -l)
                if [ "$CPU_VARIANT_COUNT" -eq 0 ]; then
                  echo "‚ùå ERROR: No CPU variant libraries found for arm64-v8a"
                  echo "  Expected: libggml-cpu-android_armv8*.so"
                  exit 1
                else
                  echo "‚úÖ Found $CPU_VARIANT_COUNT CPU variant libraries for arm64-v8a"
                fi
              else
                # For other ABIs, check for single libggml-cpu.so
                if [ ! -f "android/src/main/jniLibs/$ABI/libggml-cpu.so" ]; then
                  echo "‚ùå ERROR: Missing libggml-cpu.so for $ABI"
                  exit 1
                fi
              fi
            done
            echo "‚úÖ All required Android libraries verified"
          fi
          
          if [ ! -d "ios/libs/llama.xcframework" ] || [ ! "$(ls -A ios/libs/llama.xcframework 2>/dev/null)" ]; then
            echo "‚ùå iOS framework missing!"
            exit 1
          else
            echo "‚úÖ iOS framework present"
            ls -la ios/libs/llama.xcframework
          fi
      
      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_SECRET }}

